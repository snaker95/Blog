---
title: 读书之设计与实现 - 简单动态字符串
categories: Redis   
tags: Redis
keywords: [Redis]
description: 读书使人进步

---

[TOC]

# 简单动态字符串 SDS

## 定义:

 * simple dynamic string SDS 简单动态字符串: 通过C语言结构体来实现
 * C语言传统字符串: 以空字符(\0)结尾的字符数组

##  SDS格式及结构体

* 格式

```c
struct sdshdr {
    // 记录buf数组中已使用字节的数量
    // 为SDS保存字符串的长度
    int len;
    // 记录buf数组中未使用字节的数量
    int free;
    // 字节数组, 保存字符串
    vhar buf[];
}
```

SDS遵循C字符串以空字符(\0)结尾的惯例, 保存空字符的1个字节空间不计算在SDS的`len`属性中, 至于额外的1字节空间以及将其添加在字符串末尾的操作都是由SDS函数自动完成;

* 与C字符串的区别
  * 获取字符串长度的复杂度
    * C字符串没有记录字符串长度的属性, 计数复杂度为O(N);
    * SDS字符串存在len属性, 计算复杂度为O(1);
  * 缓存区溢出
    * C字符串由于没有记录字符串长度, 在使用例如`strcat`函数时, 容易缓存溢出; 修改相邻空间的字符串
    * SDS字符串API会先检查空间是否满足需求, 然后进行操作
  * 修改字符串带来的内存重新分配次数
    * C字符串在修改时, 每次都会造成内存重新分配
    * SDS字符串采用`空间预分配`和`惰性空间释放`来减少对内存重新分配
      * `空间预分配` : 修改时当空间不满足时重新分配内存空间: 
        * 当小于1Mb时, 分配相同大小的空闲空间(fee=len), 以防后续修改时重新分配
        * 当大于1Mb时, 分配1Mb的空闲空间(fee=1Mb)
      * `惰性空间释放`: 当修改字符串缩短时, 不会立即释放空间, 等程序结束或者调用销毁时释放
  * 二进制安全 binary-safe
    * C字符串一般以某种编码(ASCII等)除结尾的空字符(\0)外进行编码存放; 具有局限性;
    * SDS字符串使用二进制安全存放, 数据怎样存放就怎样取出;
* 参考 [Redis 设计与实现 - 简单动态字符串](http://redisbook.com/preview/sds/content.html)

Author [@Snaker95][1]

[1]: http://www.sharedsea.com

