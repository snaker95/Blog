# 微服务概览

听毛大的课程后, 其实更多的得到的是思考, 所以, 认识微服务从这些思考入手

* 微服务是什么? 以及优点、缺点
* 为什么要用微服务
* 微服务拆分理念
* 微服务构建
* 微服务间的交互
* 微服务相关的项目管理

## 微服务是什么

谈微服务首先会提到 SOA(面向服务), 那么到底 SOA是什么, 与微服务是什么关系?

* #### SOA(面向服务的架构模式)是什么

  * SOA 是一种方法论
  * **小即是美**, 小的服务代码少，bug 也少，易测试，易维护，也更容易不断迭代完善的精致进而美妙
  * **单一职责，**一个服务只做一件事情
  * **尽可能的早的创建原型，**先定义 API，达成契约
  * **可移植性比效率更重要，**通讯协议的可移植性更加重要

* ### SOA 与微服务是什么关系

  * 微服务是 SOA(面向服务的架构模式)的一种实践, 
  * 微服务也是 SOA 的一种框架

* ### 微服务是什么

  * 围绕业务功能构建的
  * 服务关注单一业务
  * 服务间采用轻量级的通信机制
  * 可以全自动独立部署
  * 可以使用不同的编程语言和数据存储技术

  特点:

  * 原子服务
  * 独立进程
  * 隔离部署
  * 去中心化服务治理

  所以其概念和特点就是其**优点**

* ### 缺点 (来之[mohuishou](https://lailin.xyz/post/go-training-01.html))

  - 服务之间的依赖关系复杂，成千上万个服务相互依赖就像一团乱麻一样，剪不断理还乱。
  
    - 常见的解决方案：全链路追踪，例如， opentracing
  
  - 微服务本身是分布式系统，需要使用 RPC 或者 消息进行通信，此外，必须要写代码来处理消息传递中速度过慢或者服务不可用等局部失效问题
  
    - 例子：服务调用流量会容易被放大，如果 服务 A -> B ->C 如果 A 有一个循环调用 B，B 也有一个循环调用 C，那么一个请求到达 C 之后就被放大了 100 倍甚至上千倍。这是扛不住的
    - **常见解决方案：粗粒度的进程间通信（batch 接口，批量请求，避免 n+1 问题），隔离，超时保护，负载保护，熔断、限流、降级、重试，负载均衡**
  
  - 会有分布式事务问题，因为现在每个微服务之间都会有一个独立的数据库，事务在单体应用中很好处理，但是在跨服务时会变得很麻烦
  
    - 常见解决方案：两阶段提交、TCC 等
    - [小米信息部技术团队: 分布式事务，这一篇就够了](https://xiaomi-info.github.io/2020/01/02/distributed-transaction/)
  
  - 测试会非常复杂，由于依赖多，无法得知是因为功能异常还是依赖的某个服务发版出现问题
  
    - 常见解决方案：独立测试环境，后面会有一个解决方案
  
  - 服务模块间的依赖，应用的升级有可能会波及多个服务模块的修改。
  
    - 切记，在服务需要变更时我们要特别小心，服务提供者的变更可能引发服务消费者的兼容性破坏，**时刻谨记保持服务契约(接口)的兼容性**
    - 发送时要保守，接收时要开放。按照伯斯塔尔法则的思想来设计和实现服务时，发送的数据要更保守，意味着最小化的传送必要的信息，接收时更开放意味着要最大限度的容忍冗余数据，保证兼容性。
  
    - 对基础建设的要求很高，基础设施需要自动化，日志采集，监控数据采集，告警，gitlab + gitlab hooks + CICD，K8s 等
    - 常见解决方案：上云

## 微服务拆分理念

* 对业务领域不是很熟悉, 可按照**部门职能** 进行拆分, 例如: 财务，账号等
* 积累经验后, 对业务领域有深刻了解后, 可考虑 **DDD** 限界上下文进行划分
* 相同功能或者服务尽量收敛, 完成闭环, 其实与中台概念同出一辙

## 微服务构建

一个完整的业务场景(usecase)可能有多个微服务组合(compose)而成, 虽然每个微服务都可以使用不同的语言开发, 但是,如果统一语言开发时, 尽量使用统一的代码框架和格式进行开发, 好处嘛, 可以形成公司统一风格, 人员变动时, 学习成本降低;

* kit：一个微服务的基础库(框架)。
* service：业务代码 + kit 依赖 + 第三方依赖组成的业务微服务
* rpc(同步) + message queue(异步)：轻量级通讯

## 微服务间的交互

![01_Go进阶训练营_微服务_v1.svg](01 微服务.assets/1606552913072-f2ae26c9-6897-4dc8-9384-95f493ff5006.svg)

* 流量链路是什么？
  * 移动端 -> API Gateway -> BFF -> 微服务
  * 不含 CDN、负载均衡（LB）
  * BFF 纯 web 的业务一般用 nodejs 做 SSR
    * 只做组合, 不做业务处理

* 为什么我们的服务不直接对外进行暴露？
  * 前端（移动端、客户端、web）同学非常痛苦，需要对接多个服务，兼容性差，沟通效率低
  * 后端同学也很痛苦，一年前的版本都有人使用，服务无法进行重构升级

* 为什么需要最外层的 api gateway?
  * 将于业务无关的功能进行分离，限流熔断安全等业务无关的功能需要进行升级的时候升不动

## 微服务相关的项目管理

* you build it, you run it
  * 研发负责到底, 要对自己的代码负责到底, 从开发到测试, 再到部署上线,  但这一切的前提是, 自动化部署



参考: go 进阶训练营

[mohuisou - 微服务(一) 微服务概览](https://lailin.xyz/post/go-training-01.html)

